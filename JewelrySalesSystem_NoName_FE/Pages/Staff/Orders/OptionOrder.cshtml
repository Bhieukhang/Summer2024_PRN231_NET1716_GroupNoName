@page
@model JewelrySalesSystem_NoName_FE.Pages.Staff.Orders.OptionOrderModel
@{
}
@Html.AntiForgeryToken()
<body>
    <div class="main-panel">
        <div class="content-wrapper">
            <div class="page-header">
                <h3 class="page-title"> Tạo đơn hàng - Bước 2 (Tùy chọn) </h3>
            </div>
            <div class="row" style="height: 100%;">
                <!-- Left side: Product list -->
                <div class="col-md-8 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Trang sức</h4>
                            <p><em style="color:lightseagreen">Chỉ gia công kim cương và giá gia công là cố định. Nếu khách hàng không gia công có thể bỏ qua mục này</em></p>
                            <div class="container">
                                <table class="table table-bordered">
                                    <tbody id="productTableBody">
                                        <!-- Các sản phẩm sẽ được thêm vào đây -->
                                        @foreach (var order in Model.orderDetailProccesses)
                                        {
                                            <div class="form-group row">
                                                <div class="col-md-3">
                                                    <label class="control-label">Mã sản phẩm</label>
                                                    <input type="text" class="form-control" value="@order.ProductName" readonly />
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="control-label">Số lượng</label>
                                                    <input type="text" class="form-control" value="@order.Quantity" readonly />
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="control-label">Giá sản phẩm</label>
                                                    @{
                                                        double amount = (double)order.Amount;
                                                        var formattedAmount = amount != 0 ? string.Format(new System.Globalization.CultureInfo(""), "{0:N0}", amount) : "";
                                                    }
                                                    <input type="text" class="form-control" value="@formattedAmount" readonly />
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="control-label">Giá thi công</label>
                                                    <input type="hidden" id="originalProcessPrice" value="@order.ProcessPrice">
                                                    @{
                                                        double processPrice = order.ProcessPrice;
                                                        var formattedProcessPrice = processPrice != 0 ? string.Format(new System.Globalization.CultureInfo(""), "{0:N0}", processPrice) : "";
                                                    }
                                                    <input type="text" id="formattedProcessPrice" class="form-control" value="@formattedProcessPrice" readonly />
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="control-label" for="process-price">Gia công</label>
                                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#chooseProductModal-@order.Id">Chọn gia công</button>

                                                    <!-- Modal Proccess Product -->
                                                    <div class="modal fade" id="chooseProductModal-@order.Id" tabindex="-1" role="dialog" aria-labelledby="chooseProductModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog" role="document">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="chooseProductModalLabel">Chọn sản phẩm</h5>
                                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                        <span aria-hidden="true">&times;</span>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <div class="col-sm-12 autocomplete">
                                                                        <div class="form-check">
                                                                            <input type="checkbox" id="process-price-@order.Id" value="@order.ProcessPrice" class="form-check-input process-checkbox">
                                                                            <label class="form-check-label" for="process-price-@order.Id">Gia công sản phẩm</label>
                                                                        </div>
                                                                        <input type="text" id="searchCode-@order.Id" name="searchCode" class="form-control" placeholder="Nhập mã code của kim cương cần tìm"
                                                                               autocomplete="off" onkeyup="autocompleteSearch(this.value, this, '@order.Id')" value="" />
                                                                        <div id="autocomplete-list-@order.Id" class="autocomplete-items"></div>
                                                                    </div>
                                                                    <div id="selected-products-@order.Id" class="selected-products"></div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <label class="control-label">Tổng giá tiền: </label>
                                                                    <span id="totalProccessProduct-@order.Id">0</span>
                                                                    <button type="button" class="btn btn-primary confirm-button" id="confirmButton" data-order-id="@order.Id">Xác nhận</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right side: Customer and Order details -->
                <div class="col-md-4 grid-margin stretch-card" style="display: flex; flex-direction: column;">
                    <div class="card" style="flex-grow: 1;">
                        <div class="card-body">
                            <h4 class="card-title">Thông tin thành viên</h4>
                            @* Hiển thị lỗi *@
                            <div id="message-container"></div>
                            <div class="container">
                                <div class="row">
                                    <!-- Cột bên trái -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Số điện thoại</label>
                                            <input type="text" id="customerPhone" name="phone" class="form-control" placeholder="Nhập số điện thoại" value="@Model.member.Phone" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label>Tên khách hàng</label>
                                            <input type="text" id="customerName" name="fullName" class="form-control" placeholder="Nhập tên khách hàng" value="@Model.member.Name" readonly>
                                        </div>
                                    </div>
                                    <!-- Cột bên phải -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Mức độ</label>
                                            @if (@Model.member.Type == "NewMember")
                                            {
                                                <input type="text" class="form-control" value="Thành viên mới" readonly style="background-color: green; color: white;">
                                                <input type="text" id="level" name="level" class="form-control" value="@Model.member.Type" readonly hidden>
                                            }
                                            else if (Model.member.Type == "Bronze")
                                            {
                                                <input type="text" class="form-control" value="Thành viên đồng" readonly style="background-color: 	rgb(96, 64, 32); color: white;">
                                                <input type="text" id="level" name="level" class="form-control" value="@Model.member.Type" readonly hidden>
                                            }
                                            else if (Model.member.Type == "Silve")
                                            {
                                                <input type="text" class="form-control" value="Thành viên bạc" readonly style="background-color: 	rgb(128, 128, 128); color: white;">
                                                <input type="text" id="level" name="level" class="form-control" value="@Model.member.Type" readonly hidden>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control" value="Thành viên vàng" readonly style="background-color: 	rgb(255, 255, 0); color: white;">
                                                <input type="text" id="level" name="level" class="form-control" value="@Model.member.Type" readonly hidden>
                                            }
                                        </div>
                                        <div class="form-group">
                                            <label>Tích lũy</label>
                                            <input type="hidden" id="originalUserMoney" value="@Model.member.UserMoney">
                                            <input type="text" id="usedMoney" name="usedMoney" class="form-control" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="container">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <labl>Chiết khấu đề xuất(%)</labl>
                                            <input type="text" id="percentDiscount" name="percentDiscount" class="form-control"
                                                   value="@(Model.member.PercentDiscount * 100)">
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <labl>Ghi chú</labl>
                                            <textarea type="textarea" id="description" name="description" class="form-control"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-12 row g-0">
                                        <div class="col-md-6 text-left" style="padding-right: 5px;">
                                            <button type="button" class="btn custom-button" id="requestDiscountBtn"
                                                    data-order-id="@Model.OrderProccess.OrderId"
                                                    data-manager-id="00000000-0000-0000-0000-000000000000" style="white-space: nowrap;">
                                                Yêu cầu chiết khấu
                                            </button>
                                        </div>
                                        <div class="col-md-6 text-right" style="padding-left: 50px;">
                                            <button type="button" class="btn btn-gradient-secondary" data-toggle="modal" data-target="#discountModal"
                                                    data-id="@Model.OrderProccess.OrderId">
                                                Phản hồi
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group"></div>
                                    <div class="col-md-12">
                                        <!-- Customer Information -->
                                        <input type="hidden" id="orderId" value="@Model.OrderProccess.OrderId">
                                        <input type="hidden" id="managerId" value="00000000-0000-0000-0000-000000000000">
                                        <!-- Customer Information -->
                                        <h4 class="card-title">
                                            Tổng tiền (tạm tính): <span id="totalPrice" data-value="@Model.OrderProccess.TotalPrice">Đ</span>
                                        </h4>
                                        <h4 class="card-title">Chiết khấu giảm: <span id="totalDiscount" data-value="0">0</span></h4>
                                        <h4 class="card-title">Giá thi công: <span id="totalProccess" data-value="0">0</span></h4>
                                        <h4 class="card-title">Sản phẩm thi công: <span id="totalProccessProduct" data-value="0">0</span></h4>
                                        <h4 class="card-title">Tổng tiền cần thanh toán: <span id="totalPayable" data-value="0">0</span></h4>
                                        <div class="form-group">
                                            <h4 for="paymentMethod">Phương thức thanh toán</h4>
                                            <div class="select-wrapper">
                                                <select class="form-select" id="paymentMethod" style="height: 4.0rem;">
                                                    <option value="" selected>Chọn phương thức thanh toán</option>
                                                    <option value="transfer">Chuyển khoản</option>
                                                    <option value="cash">Thanh toán bằng tiền mặt</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="container">
                                            <div class="row">
                                                <input type="hidden" id="requestVerificationToken" value="">
                                                <button id="createOrderBtn" class="btn btn-success" style="white-space: nowrap;">Hoàn thành</button>
                                                <div class="form-group"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        @*  Modal Discount Reply *@
        <div class="modal fade" id="discountModal" tabindex="-1" role="dialog" aria-labelledby="discountModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="discountModalLabel">Thông tin chi tiết Discount</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="discountContent">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Popup Discount Exit-->
        <div class="modal fade" id="exitDiscountModal" tabindex="-1" aria-labelledby="exitDiscountModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exitDiscountModalLabel">Thông báo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <h3>Đơn hàng này đã có triết khấu</h3>
                    </div>
                    <div class="modal-footer">
                        @* <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button> *@
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Popup Order Successfully-->
        <div class="modal fade" id="successOrderModal" tabindex="-1" aria-labelledby="successOrderModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="successOrderModalLabel">Thông báo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <h3>Đơn hàng đã được tạo</h3>
                    </div>
                    <div class="modal-footer">
                        @* <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button> *@
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal ZALO PAY-->
        <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel"
             data-target=".bd-example-modal-lg" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderModalLabel">Thanh toán</h5>
                    </div>
                    <div class="modal-body">
                        <iframe id="orderFrame" src=""></iframe>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelBtn" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" id="continueBtn" data-bs-dismiss="modal">Tiếp tục</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Small Modal for Cash Payment Confirmation -->
        <div class="modal fade" id="cashPaymentModal" tabindex="-1" role="dialog" aria-labelledby="cashPaymentModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cashPaymentModalLabel">Hoàn tất</h5>
                    </div>
                    <div class="modal-body">
                        <span class="loader"></span>
                        Chờ thanh toán . . . . . . .
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelConfirmCash" data-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" id="confirmCashPayment">Xác nhận thanh toán</button>
                    </div>
                </div>
            </div>
        </div>


</body>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
    <script>

        document.addEventListener("DOMContentLoaded", function () {
            //Format: TotalPrice
            var totalPriceElement = document.getElementById("totalPrice");
            var totalPrice = totalPriceElement.getAttribute("data-value");
            totalPrice = Number(totalPrice).toLocaleString();
            totalPriceElement.textContent = totalPrice + '  Đ';
            //Format: UserMoney
            var originalUserMoney = document.getElementById("originalUserMoney").value;
            var formattedUserMoney = parseFloat(originalUserMoney).toLocaleString();
            document.getElementById("usedMoney").value = formattedUserMoney;
            //Format: ProccessPrice
            var originalProcessPrice = document.getElementById("originalProcessPrice").value;
            var formattedProcessPrice = parseFloat(originalProcessPrice).toLocaleString();
            var formattedProcessPrice = parseFloat(originalProcessPrice).toLocaleString();
            document.getElementById("formattedProcessPrice").value = formattedProcessPrice;
            //Format: TotalPayble
            var totalPayableElement = document.getElementById("totalPayable");
            var totalPayable = totalPrice;
            totalPayableElement.textContent = totalPayable.toLocaleString() + '  Đ';
        });

        //Choose Product Proccess
        let selectedDiamonds = {};
        let isConfirmed = false;
        let totalProccess = 0; 
        let totalPayable = 0;
        let discount = 0;
        let totalProccessProduct = 0;
        let totalProccessList = 0;

        function autocompleteSearch(query, inputElement, orderId) {
            let autocompleteList = document.getElementById("autocomplete-list-" + orderId);

            if (!autocompleteList) {
                console.error("Autocomplete list element not found.");
                return;
            }

            if (query.length === 0) {
                autocompleteList.innerHTML = "";
                return;
            }

            fetch(`https://localhost:44318/api/v1/Diamond/autocomplete?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    autocompleteList.innerHTML = "";
                    data['$values'].forEach(item => {
                        let suggestionItem = document.createElement("div");
                        suggestionItem.classList.add("autocomplete-item");

                        suggestionItem.innerHTML = `
                            <img class="diamond-image-search" src="${item.imageDiamond}" alt="Diamond image">
                            <div class="diamond-details-search">
                                <h5 class="diamond-name-search">${item.diamondName}</h5>
                                <p class="diamond-code-search">Code: <strong>${item.code}</strong></p>
                            </div>`;

                        suggestionItem.onclick = function () {
                            let searchCodeElement = document.getElementById("searchCode-" + orderId);
                            if (searchCodeElement) {
                                searchCodeElement.value = item.code;
                            } else {
                                console.error("Input element not found.");
                            }
                            if (item.quantity > 0) {
                                console.log("Item: ", item);
                                addProductToList(item, orderId);
                            } else {
                                alert("This product is out of stock.");
                            }
                            autocompleteList.innerHTML = "";
                        };

                        autocompleteList.appendChild(suggestionItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching autocomplete data:', error);
                    autocompleteList.innerHTML = "";
                });
        }
      
        function addProductToList(item, orderId) {
            let totalProccessProductElement = document.getElementById('totalProccessProduct-' + orderId);
            let selectedProductsElement = document.getElementById('selected-products-' + orderId);

            if (!totalProccessProductElement || !selectedProductsElement) {
                console.error("Elements not found.");
                return;
            }

            // Check if a product is already selected for processing
            if (selectedProductsElement.children.length > 0) {
                console.log("Only one product can be selected for processing.");
                return;
            }

            // Update total price
            let price = parseFloat(item.price);
            let currentTotal = parseFloat(totalProccessProductElement.innerText.replace(/,/g, ''));
            let newTotal = currentTotal + price;
            totalProccessProductElement.innerText = newTotal.toLocaleString();

            // Create the selected product element
            let selectedItem = document.createElement("div");
            selectedItem.classList.add("selected-item");

            selectedItem.innerHTML = `
                <div class="diamond-details">
                    <img class="diamond-image-selected" src="${item.imageDiamond}" alt="Diamond image">
                    <div class="diamond-details-selected">
                        <h5 class="diamond-name-selected">${item.diamondName}</h5>
                        <p class="diamond-code-selected">Code: <strong>${item.code}</strong></p>
                        <p class="diamond-price-selected">Price: <strong>${item.price}</strong></p>
                    </div>
                    <button class="remove-item-button" data-price="${price}" data-product-id="${item.code}">Xóa</button>
                </div>`;

            selectedProductsElement.appendChild(selectedItem);

            selectedItem.querySelector('.remove-item-button').addEventListener('click', function () {
                removeProductFromList(price, orderId, item.code, selectedItem);
            });

            if (!selectedDiamonds[orderId]) {
                selectedDiamonds[orderId] = {};
            }
            selectedDiamonds[orderId][item.code] = item; 
        }

        function removeProductFromList(price, orderId, productCode, selectedItem) {
            let totalProccessProductElement = document.getElementById('totalProccessProduct-' + orderId);
            let selectedProductsElement = document.getElementById('selected-products-' + orderId);

            if (!totalProccessProductElement || !selectedProductsElement) {
                console.error("Elements not found.");
                return;
            }

            let currentTotal = parseFloat(totalProccessProductElement.innerText.replace(/,/g, ''));
            let newTotal = currentTotal - price;
            totalProccessProductElement.innerText = newTotal.toLocaleString();

            delete selectedDiamonds[orderId][productCode]; 

            if (selectedItem && selectedItem.parentNode === selectedProductsElement) {
                selectedProductsElement.removeChild(selectedItem);
            } else {
                console.error("Selected item is not a valid Node or does not belong to the selected products element.");
            }

            totalProccess -= price; 
            totalProccessList -= price;
            updateTotalPayable(0, totalProccess);

            if (selectedProductsElement.children.length === 0) {
                isConfirmed[orderId] = false;
                $('.confirm-button[data-order-id="' + orderId + '"]').prop('disabled', false);
            }
        }

        function updateTotalPayable(totalProccessProduct, totalProccess) {
            var totalPriceStr = $('#totalPrice').attr('data-value');
            var totalPrice = parseFloat(totalPriceStr);
            if (isNaN(totalPrice)) {
                console.error("Invalid total price:", totalPriceStr);
                totalPrice = 0;
            }

            var totalDiscountStr = $('#totalDiscount').text();
            var totalDiscount = parseFloat(totalDiscountStr);
            if (isNaN(totalDiscount)) {
                console.error("Invalid total discount:", totalDiscountStr);
                totalDiscount = 0;
            }

            totalProccessList += totalProccessProduct;
            var totalPayable = totalPrice - totalDiscount + totalProccessList;

            if (isNaN(totalPayable)) {
                console.error("Invalid total payable:", totalPrice, totalDiscount, totalProccess);
                totalPayable = 0;
            }
            console.log("Tồng tiền: ", totalPayable, totalPriceStr);
            $('#totalPrice').text(totalPayable.toLocaleString() + '  Đ');
            $('#totalPayable').text(totalPayable.toLocaleString() + '  Đ');
            $('#totalProccessProduct').text(totalProccessList.toLocaleString() + '  Đ');
            $('#totalProccess').attr('data-value', totalProccess);
        }
        //Calculate price
        $(document).ready(function () {
            let totalProccess = 0;


            // Handle checkbox change event
            $('.process-checkbox').change(function () {
                var processPriceStr = $(this).val();
                var processPrice = parseFloat(processPriceStr);
                if (isNaN(processPrice)) {
                    console.error("Invalid process price:", processPriceStr);
                    processPrice = 0;
                }

                if (this.checked) {
                    totalProccess += processPrice;
                } else {
                    totalProccess -= processPrice;
                }
                $('#totalProccess').text(totalProccess.toLocaleString() + '  Đ');
                updateTotalPayable(0, totalProccess);
            });

            $('.confirm-button').on('click', function () {
                var orderId = $(this).data('order-id');
                console.log("OrderId: ", orderId);
                if (isConfirmed[orderId]) {
                    console.log("The product has already been confirmed.");
                    return;
                }

                let selectedProductsElement = document.getElementById('selected-products-' + orderId);
                if (selectedProductsElement.children.length !== 1) {
                    console.log("Please select only one product for processing.");
                    return;
                }

                // Get the selected product code for the given orderId
                let selectedProductCodes = Object.keys(selectedDiamonds[orderId]);
                if (selectedProductCodes.length !== 1) {
                    console.log("No product selected for processing.");
                    return;
                }

                let selectedProductCode = selectedProductCodes[0];
                let selectedProduct = selectedDiamonds[orderId][selectedProductCode];
                if (!selectedProduct) {
                    console.log("Selected product not found.");
                    return;
                }

                if (selectedProduct.quantity <= 0) {
                    console.log("The selected product is out of stock.");
                    return;
                }

                selectedProduct.quantity--;

                isConfirmed[orderId] = true;
                console.log("Product confirmed for processing.");
                console.log("Price: ", selectedProduct.price);
                closeModal(orderId);
                updateTotalPayable(selectedProduct.price, totalProccess);

                $(this).prop('disabled', true);
            });

            function closeModal(orderId) {
                $('#chooseProductModal-' + orderId).modal('hide');

                $('#chooseProductModal-' + orderId).on('hide.bs.modal', function (e) {
                    console.log("Modal is being hidden");
                });

                $('#chooseProductModal-' + orderId).on('hidden.bs.modal', function (e) {
                    console.log("Modal has been hidden");
                });
            }

            $(document).on('click', '.remove-item-button', function () {
                let price = parseFloat($(this).data('price'));
                let orderId = $(this).data('order-id');
                let productCode = $(this).data('product-code');
                let selectedItem = $(this).closest('.product-item')[0]; // Đảm bảo selectedItem là một Node

                removeProductFromList(price, orderId, productCode, selectedItem);
            });
        });


        //Create discount to send Manager
        $(document).ready(function () {
            var previousValue = $('#paymentMethod').val();
            // $('#orderModal').on('hidden.bs.modal', function () {
            //     $('#createOrderBtn').click();
            // });
            let action = '';

            $('#continueBtn').on('click', function () {
                console.log('Continue button clicked');
                action = 'continue';
            });

            $('#cancelBtn').on('click', function () {
                console.log('Cancel button clicked');
                action = 'cancel';
            });

            $('#orderModal').on('hidden.bs.modal', function () {
                console.log('Modal hidden');
                if (action === 'continue') {
                    console.log('Creating order');
                    $('#createOrderBtn').click();
                }
                action = '';
            });
            $('#cancelBtn').on('click', function () {
                $(this).data('action', '');
            });

            $('#paymentMethod').change(function () {
                if ($(this).val() === 'cash') {
                    $('#cashPaymentModal').modal('show');
                }
            });

            $('#confirmCashPayment').click(function () {
                $('#createOrderBtn').click();
                $('#cashPaymentModal').modal('hide');
            });

            $('#cancelConfirmCash').click(function () {
                $('#paymentMethod').val(previousValue);
                $('#cashPaymentModal').modal('hide');
            });
            var discountIdAccepted = null;
            const token = $('input[name="__RequestVerificationToken"]').val();
            //Zalo Pay
            $('#paymentMethod').change(function () {
                var selectedValue = $(this).val();
                if (selectedValue === 'transfer') {
                    var totalPricePayable = parseFloat($('#totalPayable').text().replace(/[^0-9.-]+/g, "") || 0);
                    var OrderId = $('#orderId').val();
                    console.log("Total price, orderId: ", totalPricePayable, OrderId);
                    var data = {
                        orderId: OrderId,
                        totalPrice: totalPricePayable,
                        status: 0
                    };

                    $.ajax({
                        url: 'https://localhost:44318/api/Payment/create-order',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        success: function (response) {
                            $('#orderId').text('Order ID: ' + response.orderId);
                            $('#totalPrice').text('Total Price: ' + response.totalPrice);
                            $('#status').text('Status: ' + response.status);
                            console.log("Link zalo pay: ", response.order_url);
                            if (response.order_url) {
                                $('#orderFrame').attr('src', response.order_url);
                            }

                            $('#orderModal').modal('show');
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });

            $('#requestDiscountBtn').click(function () {
                const orderId = $('#orderId').val();
                const managerId = $('#managerId').val();
                const percentDiscount = $('#percentDiscount').val();
                const description = $('#description').val();
                // const token = $('input[name="__RequestVerificationToken"]').val();

                const discountRequest = {
                    OrderId: orderId,
                    ManagerId: managerId || "00000000-0000-0000-0000-000000000000",
                    PercentDiscount: parseInt(percentDiscount, 10),
                    Description: description,
                    ConditionDiscount: 0
                };

                console.log("Discount request: ", discountRequest);
                console.log("Token create: ", token);
                $.ajax({
                    url: '/Staff/Orders/OptionOrder?handler=SendRequirement',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(discountRequest),
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function (response) {
                        console.log("Response discount: ", response);
                        if (response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        } else if (response.success == false) {
                            $('#exitDiscountModal').modal('show');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("Lỗi")

                    }
                });
            });

            $('#discountModal').on('show.bs.modal', function (event) {
                let button = $(event.relatedTarget);
                let discountId = button.data('id');
                loadDiscountData(discountId);
            });

            //Receive discount from Manager
            function loadDiscountData(id) {
                $.ajax({
                    url: 'https://localhost:44318/api/v1/discount/accepted',
                    type: 'GET',
                    data: { id: id },
                    success: function (data) {
                        console.log("Load tới  loadDiscountData ");
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);
                            } catch (e) {
                                console.error('Error parsing data:', e);
                                $('#discountContent').html('<p>Error: Unable to parse data from server</p>');
                                return;
                            }
                        } else if (data.message === 'Chưa có phản hồi từ quản lí') {
                            console.log("Load data.message: ", data.message);
                            $('#discountContent').html('<p><strong>Chưa có phản hồi từ quản lí</strong></p>');
                            return;
                        }

                        // Check if the data represents an empty object
                        if (isEmptyObject(data)) {
                            console.log("load dô isEmpty");
                            $('#discountContent').html('<p><strong>Chưa có phản hồi từ quản lí</strong></p>');
                        } else {
                            discountIdAccepted = data.Id;
                            let statusMessage;
                            if (data.Status === 'Accepted') {
                                statusMessage = 'Phần trăm chiết khấu được chấp nhận';
                                // Calculate the discounts
                                let totalPrice = parseFloat('@Model.OrderProccess.TotalPrice');
                                let discountPercent = parseFloat(data.PercentDiscount) / 100;
                                let totalDiscount = totalPrice * discountPercent;
                                let materialProcessPrice = parseFloat($('#totalProccess').text().replace(/[^0-9.-]+/g, ""));
                                let totalProccessProduct = parseFloat($('#totalProccessProduct').text().replace(/[^0-9.-]+/g, ""))
                                let totalPayable = totalPrice - totalDiscount + materialProcessPrice + totalProccessProduct;


                                $('#totalPayable').text(totalPayable.toLocaleString() + '  Đ');
                                $('#totalDiscount').text(totalDiscount.toLocaleString() + '  Đ');
                            } else if (data.Status === 'Rejected') {
                                console.log("Discount reject:", data.Status);
                                statusMessage = 'Phần trăm chiết khấu không được chấp nhận';
                            } else {
                                statusMessage = data.Status;
                            }

                            // Hiển thị dữ liệu thực tế
                            let html = '<ul class="list-group">';
                            html += `<li class="list-group-item"><strong>ID:</strong> ${data.Id}</li>`;
                            html += `<li class="list-group-item"><strong>Trạng thái:</strong> ${statusMessage}</li>`;
                            html += `<li class="list-group-item"><strong>Phần trăm (%):</strong> ${data.PercentDiscount}</li>`;
                            if (data.Note) {
                                html += `<li class="list-group-item"><strong>Note:</strong> ${data.Note}</li>`;
                            } else {
                                html += `<li class="list-group-item"><strong>Note:</strong> Không có ghi chú</li>`;
                            }
                            html += '</ul>';
                            $('#discountContent').html(html);
                        }
                    },
                    error: function (error) {
                        console.error('Error loading discount data', error);
                        $('#discountContent').html('<p>Error loading data</p>');
                    }
                });
            }

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:44318/signalrServer")
                .build();
            const debouncedLoadDiscountData = debounce(loadDiscountData, 3000);

            connection.on("DiscountAccpetNotification", function () {
                console.log('Discount status changed');
                debouncedLoadDiscountData(orderId);
            });

            connection.start().then(function () {
                console.log('SignalR connected.');
            }).catch(function (err) {
                console.error('SignalR connection error:', err.toString());
            });

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function isEmptyObject(obj) {
                return Object.keys(obj).every(key => obj[key] === null || obj[key] === "" || obj[key] === "00000000-0000-0000-0000-000000000000");
            }

            $('#createOrderBtn').click(function () {
                console.log("Chạy nè!!!", $('#totalDiscount').text(), $('#totalPrice'), $('#totalProccess').text());
                var discountId = $('#totalDiscount').text().replace(/[^0-9.-]+/g, "") || null;

                var totalPricePayable = parseFloat($('#totalPayable').text().replace(/[^0-9.-]+/g, "") || 0);
                console.log("Tổng tiền thanh toán: ", totalPrice);

                var materialProcessPrice = parseFloat($('#totalProccess').text().replace(/[^0-9.-]+/g, ""));
                var orderId = $('#orderId').val();
                console.log("Discount + total + proccess", discountId, totalPricePayable, materialProcessPrice);
                var orderDetails = {
                    DiscountId: discountIdAccepted,
                    TotalPrice: totalPricePayable,
                    MaterialProcessPrice: materialProcessPrice,
                    OrderId: orderId
                };
                console.log("Dữ liệu cập nhật order: ", orderDetails);
                // Gửi yêu cầu POST đến API
                $.ajax({
                    type: 'PUT',
                    url: '/Staff/Orders/OptionOrder?handler=CompleteOrder',
                    data: JSON.stringify(orderDetails),
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function (response) {
                        $('#successOrderModal').modal('show');
                        window.location.href = response.redirectUrl;
                    },
                    error: function (error) {
                        alert('Error updating order: ' + error.responseText);
                    }
                });

            });
        });


    </script>
}

<style>

    .custom-button {
        background: rgb(23,131,240);
        background: linear-gradient(0deg, rgba(23,131,240,1) 10%, rgba(49,82,192,0.9960434857536765) 73%);
        border: none;
        color: white;
    }

        .custom-button:hover {
            background: linear-gradient(0deg, rgba(100,49,192,0.9960434857536765) 27%, rgba(23,131,240,1) 100%);
        }

    .form-check {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .form-check-input {
        margin-right: 0.5em;
    }

    .green-background {
        background-color: green;
        color: white !important;
    }

    .autocomplete {
        position: relative;
        display: inline-block;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #ffffff;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
    }

    .autocomplete-item {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

        .autocomplete-item:hover {
            background-color: #e9e9e9;
        }

    .autocomplete .form-control {
        width: 100%;
    }

    .autocomplete .dropdown-menu {
        width: 100%;
    }

    .diamond-image-search, .diamond-image-selected {
        max-width: 50px;
        max-height: 50px;
        margin-right: 10px;
        border-radius: 5px;
        object-fit: cover;
    }

    .diamond-details-search, .diamond-details-selected {
        display: flex;
        flex-direction: column;
    }

    .diamond-name-search, .diamond-name-selected {
        font-size: 1rem;
        margin: 0;
        font-weight: bold;
    }

    .diamond-code-search, .diamond-code-selected {
        font-size: 0.875rem;
        margin: 0;
        color: #495057;
    }

    .diamond-price-selected {
        font-size: 0.875rem;
        margin: 0;
        color: #495057;
    }

    .remove-item-button {
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #ff0000;
        color: #ffffff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

        .remove-item-button:hover {
            background-color: #cc0000;
        }

    .diamond-details {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }



    .custom-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #000;
        pointer-events: none;
    }

    .modal-body iframe {
        width: 100%;
        height: 600px; /* Adjust height as needed */
        border: none;
    }

</style>
